<?php

use MageOS\Widgetkit\Block\Widgets\ProductSlider;
use Hyva\Theme\ViewModel\HyvaCsp;
use Magento\Framework\Escaper;

/**
 * @var ProductSlider $this
 * @var HyvaCsp $hyvaCsp
 * @var Escaper $escaper
 */

$params   = $this->getData('params');
$items    = $this->getData('items');
$uniqId   = uniqid();
$sliderId = 'product-slider-' . $uniqId;

$snapColumns     = $params['mageos_product_slider_columns'] ?? 3;
$snapColsClasses = 'md:[--snap-cols:' . $snapColumns . ']';

// Loop
$loop = (int)($params['mageos_product_slider_loop'] ?? 0);

// Slidenav (prev/next) position
$slidenavPosition = $params['mageos_product_slider_slidenav_position'] ?? 'top-right';
$isSlidenavTop    = str_contains($slidenavPosition, 'top-');
$isSlidenavBottom = !$isSlidenavTop;

// Navigation (dots pager) position
$navPosition = $params['mageos_product_slider_navigation_position'] ?? 'bottom-center';
$isNavTop    = str_contains($navPosition, 'top-');
$isNavBottom = !$isNavTop;
?>

<section
    id="<?= $sliderId ?>"
    class="snap-slider relative"
    aria-label="<?= $escaper->escapeHtmlAttr($params['mageos_product_slider_title'] ?? '') ?>"
    data-slider-type="product"
    x-data="initProductSlider<?= $uniqId ?>()"
    x-snap-slider.group-pager
    @resize.window.debounce="calcPageSize"
>
    <a
        href="#<?= $sliderId ?>-slider-end"
        class="sr-only focus:not-sr-only focus:absolute focus:z-30 focus:bg-white"
    ><?= $escaper->escapeHtml(__('Press to skip carousel')) ?></a>

    <?php if ($isNavTop || $isSlidenavTop): ?>
    <div class="items-center gap-4 mb-2">
        <?php if ($isNavTop): ?>
            <?= $this->renderNavTemplate(); ?>
        <?php endif; ?>
        <?php if ($isSlidenavTop): ?>
            <?= $this->renderSlideNavTemplate(); ?>
        <?php endif; ?>
    </div>
    <?php endif; ?>

    <?= $this->renderItems(['snapColsClasses' => $snapColsClasses]); ?>

    <?php if ($isNavBottom || $isSlidenavBottom): ?>
    <div class="items-center gap-4 mt-2">
        <?php if ($isNavBottom): ?>
            <?= $this->renderNavTemplate(); ?>
        <?php endif; ?>
        <?php if ($isSlidenavBottom): ?>
            <?= $this->renderSlideNavTemplate(); ?>
        <?php endif; ?>
    </div>
    <?php endif; ?>

    <span id="<?= $sliderId ?>-slider-end" tabindex="-1"></span>
</section>

<script>
    function initProductSlider<?= $uniqId ?>() {
        return {
            slider: null,
            loop: <?= $loop ? 'true' : 'false' ?>,
            dotsNavigation: true,
            lastSlidenavClicked: null,
            currentIndex: 0,
            pageSize: <?= $snapColumns ?>,
            init() {
                this.$nextTick(() => {
                    this.calcPageSize();
                    this.slider = this.$el;
                    this.$el.addEventListener('slideChange', () => {
                        const track = this.$el.querySelector('[data-track]');
                        if (!track || !track.children.length) return;
                        const firstSlide = track.children[0];
                        if (!firstSlide || firstSlide.offsetWidth === 0) return;
                        const lastPageIndex = Math.ceil(track.children.length / this.pageSize) - 1;
                        if (this.lastSlidenavClicked !== null) {
                            if (this.lastSlidenavClicked === 'next') {
                                this.currentIndex = Math.min(
                                    Math.ceil(track.scrollLeft / (firstSlide.offsetWidth * this.pageSize)),
                                    lastPageIndex
                                );
                            } else {
                                this.currentIndex = Math.min(
                                    Math.round(track.scrollLeft / (firstSlide.offsetWidth * this.pageSize)),
                                    lastPageIndex
                                );
                            }
                        }
                        if (this.loop) {
                            this.$el.querySelector('[data-prev]')?.removeAttribute('disabled');
                            this.$el.querySelector('[data-next]')?.removeAttribute('disabled');
                        }
                    });
                });
            },
            calcPageSize() {
                const track = this.$el.querySelector('[data-track]');
                if (track) {
                    const firstItem = track.querySelector('.slider-item');
                    if (firstItem && firstItem.clientWidth > 0) {
                        this.pageSize = Math.round(track.clientWidth / firstItem.clientWidth);
                    }
                }
            },
            set(index) {
                this.lastSlidenavClicked = null;
                this.currentIndex = index;
                const track = this.slider.querySelector('[data-track]');
                if (track) {
                    const targetSlide = track.children[index * this.pageSize];
                    if (targetSlide) {
                        targetSlide.scrollIntoView({ block: 'nearest', inline: 'start' });
                    }
                }
            },
            next() {
                this.lastSlidenavClicked = 'next';
                if (this.loop) {
                    const track = this.slider.querySelector('[data-track]');
                    if (track && track.scrollLeft + track.clientWidth >= track.scrollWidth - 1) {
                        track.children[0]?.scrollIntoView({ block: 'nearest', inline: 'start' });
                        this.lastSlidenavClicked = 'prev';
                    }
                }
            },
            prev() {
                this.lastSlidenavClicked = 'prev';
                if (this.loop) {
                    const track = this.slider.querySelector('[data-track]');
                    if (track && track.scrollLeft < 1) {
                        track.children[track.children.length - 1]
                            ?.scrollIntoView({ block: 'nearest', inline: 'end' });
                        this.lastSlidenavClicked = 'next';
                    }
                }
            },
        }
    }
    window.addEventListener('alpine:init', () => Alpine.data('initProductSlider<?= $uniqId ?>', initProductSlider<?= $uniqId ?>), {once: true})
</script>
<?php $hyvaCsp->registerInlineScript() ?>
